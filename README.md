# MiraeAsset_BigData_Festival

<br>

## 진행기간
> **2023/07/01~08/02**
<br>


## 사용 데이터

**고객데이터**

- 데이터 원천 : 미래에셋증권(고객의 거래이력 및 인구통계학적 정보와 4개월간의 자산/거래/채널접속 내역)
- 데이터 기간 : 2023년 3월
<br>

**산업별 ETF 주가데이터**

- 데이터 원천 : FinanceDataReader 패키지 활용
- 데이터 기간 : 2022.12.01. ~ 2023.06.30.
<br>

**뉴스데이터**

- 데이터 원천 : 미래에셋증권(미래에셋증권 MTS/HTS에서 제공됐던 뉴스 데이터)
- 데이터 기간 : 2022.12.01. ~ 2023.06.30.
<br>

**재무제표**

- 데이터 원천 : 금융감독원 전자공시시스템의 Open API 및 OpenDartReader 패키지 활용
- 데이터 기간 : 최근 6개년 2017~2022년의 사업보고서 내의 특정 지표 수집
<br>

**기업정보**

- 데이터 원천 : FinanceDataReader 패키지 활용
- 데이터 기간 : 최근 6개년 2017~2022년
<br>

**기업별(연도별) 주가, 시가총액, 상장주식수**

- 데이터 원천 : pykrx, FinanceDataReader 패키지 활용
- 데이터 기간 : 최근 6개년 2017~2022년

<br>




## 개발 환경
> **R, Python**
<br>

### 역할
> **데이터 수집, EDA, Data Prerprocessing, Modeling**
<br>

## 분석 주제
> **고객 및 시장 데이터를 활용한 대고객 금융 서비스 제안**
> > 1. 재무제표를 활용한 기업 군집화
> > 
> > 2. 투자성향에 따른 종목추천
> >
> > 3. 뉴스데이터를 활용한 산업별 시황 분석
<br>

## 분석 목적

- `재무제표를 활용한 기업 군집화`
    - **기업을 평가할 때 사용되는 지표는 다양**
    - 기업의 내부 가치를 평가하기 위해 재무제표, 기업의 외재적 가치를  평가하기 위해 ESG 평가 지표도 최근에 주목 받기 시작
    - 직접 재무제표를 일일이 확인하는 것은 번거로울 뿐더러 확인하더라도 잘 알지 못하거나 비교 분석하기가 어려움
    - **이러한 지표들을 활용해서 군집화를 진행 후 해석을 통한 기업 평가를 진행하는 것이 어떠한가**
- `투자 성향에 따른 종목 추천`
    - 단타, 장기 투자, 분산 투자 등 고객마다 투자성향은 각기 다름
    - 당장 이익을 원하는 고객은 단타를, 기업 분석을 해보거나 자신있는 분야의 산업에 투자하는 고객 등 어느 정도 정형화된 투자 방법이 존재하나 실상 이익을 내기는 어려움
    - **이에 제공되는 고객데이터를 활용하여 투자진단을 진행하고 각 고객이 속한 군집에서 이익을 내는 고수를 찾아 투자 성향에 따른 종목 추천 서비스를 제공**
    - **이 때 기업 군집화 서비스와 결합하여 투자 성향에 맞는 기업 군집 또한 추천**
- `뉴스 데이터를 활용한 산업 별 시황 분석`
    - 고객에 따라 관심을  가지는 산업이 상이
    - 각 산업의 시황을 살펴보기 위해서는 ETF나 뉴스 등 다양한 지표를 활용
    - 뉴스는 셀 수 없이 쏟아지며 가짜 뉴스  혹은 질 낮은 뉴스 등 일일이 살펴보기는 어려움
    - **이에 뉴스를 종합하여 산업 시황을 살펴볼 수 있도록 비트코인의 공포탐욕지수와 비슷한 산업 별 시황 지수를 제안하고자 함**

<br>

## 분석 요약

**재무제표를 활용한  기업 군집화**

1. 데이터 수집(재무제표, 기업정보, 주가)
2. Data Preprocessing
    1. 파생 변수 생성(PER, PSR,…)
3. Modeling
    1. Multiple Regression Analysis(주가 영향 주는 지표 탐색)
    2. Clustering(기업 분류)
        1. DBscan
        2. Kmeans
<br>

**투자 성향에 따른 고객  분류 및 종목 추천(기업 군집화 분석 결과 활용)**

1. Data Preprocessing
    1. 파생 변수 생성
2. Modeling(Clustering)
    1. 투자 성향 고객 군집화
    2. 투자 성향 별 고수 군집 탐색하기 위한 군집화
3. 기업 군집화 서비스와 연결하여 각 투자 성향에 맞춘 종목 추천 및 기업 군집 추천
<br>

**뉴스데이터를  활용한 산업별 시황 분석**

1. 데이터 수집
2. Data Preprocessing
    1. 뉴스 제목, 내용 추출 후 텍스트 전처리
    2. 파생 변수 생성
    3. 뉴스별 산업 시황 지수 생성
3. Modeling
    1. KoBERT모형 활용하여 뉴스 기사로 산업 시황 지수 예측하는 모델 생성
    2. 산업별 종합 시황 지수 변수 생성
    3. 각 산업 별 종합  시황 지수가 높은 뉴스 N개 추출
    4. 추출된 뉴스 제목 중 등장 빈도가 높은 토큰으로 키워드 파악 및 요약문 작성

<br>

## 분석 과정

### **재무제표를 활용한 기업 군집화**
### *데이터 수집*
<br>

**`재무제표`**

- 금융감독원 전자공시시스템의 Open API 및 OpenDartReader 패키지 활용
- 최근 6개년 2017~2022년의 사업보고서 내의 특정 지표 수집
- 코스피, 코스닥 종목 중 우선주, 스팩주는 제외하고 수집
- **기업(연도별) :**  **유동자산(단위 : 원), 유동부채, 당기순이익, 자본총계, 자산총계, 영업현금흐름, 영업이익, 매출액, 매출총이익 수집**
<br>

**`기업정보`**

- FinancceDataReader 패키지 활용
- 한국 주식 가격, 미국 주식 가격, 지수, 환율, 암호 화폐 가격, 종목 리스트 등을 제공하는 API 패키지
- **종목번호, 기업명,  업종, 산업 정보, 기업별(연도별) 종가를 수집**
<br>

**`시가총액, 상장주식수`**

- pykrx 패키지 활용
    - Naver/KRX에서 주가 정보를 크롤링하여 제공하는 API 패키지로 기업정보를 추가로 가져오기 위해 활용
- **시가총액(단위 : 원), 상장 주식 수 수집**

<br>

### *Data Preprocessing&Modeling*

- 논문 참고하여 사용할 지표 선정
    - 이원흠, 최수미.(2002).주가배수 평가모형과 저PER, 저PBR 효과에 관한 실증연구.한국증권학회지,31(1),109-149.
    - 김주은.(2022).주가매출비율(PSR)의 가치지표로서의 검증.기업경영연구,29(3),101-124.
    - 감형규, 신용재. (2019). 주가수익비율의 주가 관련성에 관한 실증 연구. 산업경제연구, 32(2),725-743.
<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/adb899a3-b102-4e59-952e-9d0be207854a" width="80%">
    </td>
  </tr>
</table>
<br>

- 유동비율 : 회사의 안정성
- EPS : 기업의 실질적인 수익성
- PER : 성장 가능성
- PBR :  유/무형 자산을 활용한 창출 이익 능력
- ROE : 투자에 대한 운용효율
- PCR : 순이익과 영업이익의 품질 평가
- POR : 순이익의 품질 평가
- PSR : 성장 가능성
- GP/A : 당기순이익은 회계 조작이 가능하나 매출총이익은 조작하기 어려워 신뢰도를 가지는 지표

<br>

**`주가 증감률에 영향을 주는 지표 확인하기 위한 다중회귀분석`**

- 종속 변수 : 전년도대비증감률
- 독립 변수 : 유동비율, EPS, PER, PBR, PCR, POR, PSR, GP/A
<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/4035bdab-64ea-4c2e-b57a-daf12295d901" width="80%">
    </td>
  </tr>
</table>
<br>

- 회귀모형의 F값은 p < 0.001로 유의한 모델
- 유동비율, EPS, PER을 제외하고서는 각 지표는 주가에 유의한 영향을 주는 것을 확인
- PER의 경우, 성장가능성을 보여주는 지표로 좀 더 긴 시간의 주가에 영향을 줄 것
- 나머지 변수의 경우도 해석적인 부분에는 문제 없으며 논문 또한 참고하여 군집화에 사용할 것으로 판단
<br>

**`기업 군집화`**

- **PER, PBR, PCR, POR, GP/A 가 음수인 경우가  존재**
    - PER의 경우 값이 작을 수록 저평가 기업으로 볼 수 있는데 음수값이 나오게 된다면 이러한 의미에 혼동이 생길 수 있음
    - `두 가지 방법`으로 나누어 코로나에 영향을 받지 않았던 2018년도를 기준으로 기업 군집화 진행

`첫 번째 군집화 : 음수값의 경우 (최댓값 - 해당값) 으로 변환, 상하위 1% 제거 후 DBSCAN`

- 음수값의 경우 (최댓값 - 해당값) 으로 변환
- 최댓값이 너무 큰 값을 가지는 경우가 있어 각 지표별로 상하위 1% 값 가지는 기업 제거
- 여전히 큰 값이 남아있어 DBSCAN을 통해 또 다른 이상치 파악하며 군집화 진행

<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/42cd8947-bc2e-4bce-93a1-ced269ac2abe" width="95%">
    </td>
  </tr>
</table>
<br>

`두 번째 군집화 : 각 지표가 전부 양수인 기업 추출한 후, 상위 1% 제거 후 K-means`

- PER, PBR, PSR, PCR이 전부 양수인  기업을 추출
- 이상치 처리 위해 각 지표별 상위 1% 값 가지는 기업 제거 후 진행
- **결과적으로 추출한 기업의 경우 당기순이익, 자본총계, 매출액, 영업현금흐름이 양수라는 의미로 좋은 기업일 가능성이 높음**
- 전부 양수인 기업을 추출하고 상위 1% 지움으로써 Outlier 기업이 거의 없음. 또한 데이터의 분포가 DBSCAN에는 적합하지 않음.
- 이에 가능한 많은 기업을 해석할 수 있도록 하기 위해 K-means 모델 사용
- Elbow Method 와 해석 가능한 군집이 생성되는지 살펴보며 군집 수 9개로 설정

<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/57e0b312-48e5-46aa-b198-f4fc64bc09b3" width="95%">
    </td>
  </tr>
</table>
<br>

`간략한 군집 해석 `

<br>

<table width="100%">
  <tr>
    <td align="left" width="50%">
      <img src="https://github.com/user-attachments/assets/ac5a96a7-c204-4a41-8824-3c243d962fdc" width="95%">
    </td>
    <td align="right" width="50%">
      <img src="https://github.com/user-attachments/assets/b42fda39-3928-4da5-ab4a-dfe3a15d19b7" width="95%">
    </td>
  </tr>
</table>

<br>

- 좌측표는 DBsan 결과, 우측표는 Kmeans 결과
- DBSCAN 의 결과에서 1,2번 군집의 경우 흔히 이야기하는 저 PER, 저PBR, 즉 저평가 기업으로 해석 가능
- K-means 의 결과에서 예상한 것과 같이 좋은 기업들을 좀 더 세분화하여 군집을 형성했음을 확인
- 두 군집 모델을 종합하여 결과해석 시 다양한 기업 평가가 가능할 것으로 예상
- DBSCAN에서의 2번 군집과 K-means에서의 5번 군집에 몰려있는 현상 확인. 이는 업종을 분류하고 각 지표의 연도별 증감 등의 변수를 추가한다면 해결 될 것으로 예상
<br>

### **투자 성향에 따른 종목 추천**
### *Data Preprocessing*

**`파생변수`**

<br>

<table width="100%">
  <tr>
    <td align="left" width="50%">
      <img src="https://github.com/user-attachments/assets/9771c5ef-b3b7-496f-baa5-b783492be916" width="95%">
    </td>
    <td align="right" width="50%">
      <img src="https://github.com/user-attachments/assets/2a0571d6-3268-4e5c-92e0-18fd1542b26a" width="95%">
    </td>
  </tr>
</table>

<br>

### *Modeling*

**`고객 군집화(투자 성향 분류 및 고수 군집 탐색)에 사용된 변수`**

- **총 자산액** : 자산규모에 따라 투자에 임하는 태도가 다르며 투자 방법 또한 상이할 것으로 자산 규모를 나누어 군집화 진행
- **현금성 자산액, 주식 자산 평가액** : 현금성 자산액과 주식 자산 평가액의 비율에 따라 투자 방식의 차이가 존재
- **체결횟수, 매수매도종목수** : 짧은 기간에 투자를 반복하는 단타의 성향을 파악 가능
- **특정 기간 이내 매도액 비중** : 단기 투자 뿐만 아닌 장기 투자의 성향 판단
- **이율, 평균이율** : 최근 달의 고수 및 평소에 이익을 꾸준히 내는 고수 등 다른 지표와 결합하여 가짜 고수 군집을 추려내는 등으로 활용

- 자산규모에 따라 데이터를 분리(실현가능성 파악하기 위해 총 자산액 1~100만원 고객으로 진행)
- **두 가지 절차에 따라 군집화 진행**
    - **투자 성향을 파악하는 군집화** 진행 후 각 군집 별로 **고수 군집을 파악하는 군집화** 진행 후 해석
    - 고객 데이터다 보니 밀도기반 군집화를 진행하면 하나의 군집을 생성하거나 대부분이 이상치로 처리됨

**`첫 번째 군집화 : 투자성향 고객 군집화(K-means)`**

- 매수 후 특정 기간 이내 매도액 비중, 체결횟수, 매수매도종목수, 보유 종목 수, 현금성 자산액, 주식 자산 평가액 변수 선택 후 K-means
- Elbow Method를 통해 군집 수 10개로 설정

<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/d6b0a5d9-0215-4f95-b1a4-f210670f8811" width="95%">
    </td>
  </tr>
</table>
<br>

- 7번 군집의 경우 단기투자자임을 알 수 있고 매우 높은 체결 횟수를 가지는 것으로 보아 초단타를 하는 군집으로 해석
- 10번 군집의 경우 중장기 투자자로 해석 될 수 있으며 나머지 군집 또한 투자성향이 두드러지게 분리되어 군집이 생성


**`두 번째 군집화 : 고수 군집 파악 군집화(K-means)`**

- 앞선 10번 군집을 선택하여 살펴봄
- 현금성 자산액, 주식 자산 평가액, 매수매도종목수, 평균이율, 최근 달 이율 변수 선택 후 군집화 진행
- Elbow Method를 통해 군집 수 12개로 설정

<br>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/50d3c797-94cd-422b-a70f-437cc2d9c101" width="95%">
    </td>
  </tr>
</table>
<br>

- 고수 파악 군집화에서는 각 군집 모두를 해석하는 것이 목적인 아닌, 고수 군집을 판별하는 것이 목적이므로 이율과 평균 이율을 집중하여 해석
- 6번 군집의 경우 4개월 평균 이율이 11.358%, 2023년 3월의 이율이 20.591% 으로 고수 군집으로 해석가능
- 11번 군집의 경우도 양수의 이율을 가지나 그 수치가 극단적으로 높음. 또한 다른 군집에 비해 적은 고객으로 구성되어 특이한 경우로 판단. 따라서 이러한 군집의 경우 세밀한 분석이 더 필요
<br>

***고수 군집을 통한 종목추천 및 기업 군집화와 연결***

- 투자성향 고객 군집에서 각 군집이 어떠한 종목을 주로 매입하는지, 각 군집에 해당하는 고수 군집이 어떠한 종목을 주로 매입하는 확인하고 비교
- 기업 군집화 서비스와 연결하여 고수 군집이 실제로 저 PER 기업과 같은 좋은 기업이라고 판단되는 기업 군집을 매입하는 확인 가능
<br>

### **투자 성향에 따른 종목 추천**
### *데이터 수집*

- FinancceDataReader 패키지 활용
- 한국 주식 가격, 미국 주식 가격, 지수, 환율, 암호 화폐 가격, 종목 리스트 등을 제공하는 API 패키지
- 기간 : 2022.12.01~2023.06.30
- **미래에셋증권에서 운용하는 TIGER ETF 관련 일별 종가 수집**

**`뉴스데이터`**

- 미래에셋 MTS/HTS에서 제공됐던 뉴스 데이터
- 기간 : 2022.12.01~2023.06.30

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/513436f3-bc0c-4e21-8d78-24f8f2c32709" width="80%">
    </td>
  </tr>
</table>
<br>

### *Data Preprocessing&Modeling*

- 업종별 ETF를 나누어 모델링
- 전일대비ETF 종가 증감율 * 뉴스 중요도 = 뉴스 별 산업 시황 지수 생성
- KoBERT 모델 이용하여 각 뉴스에 따른 산업 별 시황 지수 예측
- 각 산업 별 시황 지수가 높은 뉴스 N개 추출하여 요약문 작성

1. html 형식 제거
    1. \\r,  \\n 등 뉴스내용과 관련없는 html 문법이 포함.
    2. 기자 이메일 제거 필요
    3. 연합뉴스의 경우 뉴스 마지막에 (끝)을 기재.(끝 앞부분만 사용)
    4. 따옴표, 느낌표 등 특수문자 제거
    5. 한자 번역(제거x)
2. 기사 토큰화(Mecab 형태소 분석기)
    1. 단어를 기준으로 토큰화 진행
    2. 한국어 토큰화의 경우 OKT, 꼬꼬마, Mecab 3가지 모듈을 비교
3. 한국어 불용어 제거
    1. [Rank NL](https://www.ranks.nl/stopwords/korean) 사이트의 불용어에 [’은’, ‘는’, ‘에’, ‘도’, ‘가’]를 추가하여 불용어 사전을 생성
    2. 이후 2. 의 토큰에서 불용어에 해당하는 토큰을 제거한 데이터를 생성
4. 산업 별 시황지수 생성
    1. **뉴스별 산업 시황지수 = (전일대비 ETF종가 증감율) * (뉴스중요도)**
    2. 뉴스별 산업시황지수는 한 뉴스가 해당 산업의 증감을 판단하는 지수
    3. KoBERT 모형을 통해 뉴스별 산업 시황지수를 예측
    4. 현재 산업 시황을 판단하기 위해서는 최근 뉴스의 영향이 더 클 것. 이에 가중평균으로 현재 **산업 종합 시황지수** 를 생성할 예정
    5. **산업 종합 시황지수 D** 는 Min-Max Scaling을 통해 % 형식으로 표시하며 앞선 공포탐욕지수와 비슷한 형태로 서비스 제공할 예정

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/c04a7848-31f5-47e0-9af6-91a134ba0012" width="80%">
    </td>
  </tr>
</table>

<table width="100%">
  <tr>
    <td align="center">
      <img src="https://github.com/user-attachments/assets/b193d9f2-828a-4f67-a416-fb500407b178" width="80%">
    </td>
  </tr>
</table>
<br>

5. 뉴스 요약문  생성
    1. 각 산업 별 시황 지수가 높은 뉴스 N개 추출
    2. 뉴스 제목데이터를 이용해 산업 시황 지수가 높은 뉴스기사의 키워드 및 요약내용을 제공
    3. Mecab 형태소 분석기를 사용해 토큰화를 진행한 후, 기사데이터와 같은 전처리 기법을 진행
    4. 이후 많이 등장한 토큰 Main Corpus를 추출하여 키워드를 제공하고 Main Corpus를 input으로 추출적 요약, 추상적 요약을 진행하여 뉴스 요약문을 생성
<br>

## 분석 과정

- **`재무제표를 활용한 기업 군집화`**
    - 연도별 증감률을 더 추가하여 해석 시 PER의 효과 등 지표에 따른 다양한 해석 가능
    - 2018년을 기준으로 분석 후 군집 별 특징을 찾아낸 후 이를 활용하여 최신정보를 가지고 군집화를 진행 후 비교 분석 할 수 있을 것으로 예상
    - 간단하게 진행한 군집모델 결과로는 저 PER, PBR 기업이나 우수기업 혹은 리스크 기업 등을 찾을 수 있었음
    - 실제 서비스 개발에서는 업종 분류, 각 지표의 증감, 최근 주가의 변화 등을 추가로 활용하여 모델링 진행할 예정
    - **예상되는 결과로는 저평가 탈피 예정 기업, 최우수 기업, 하이리스크 하이리턴 기업, 재무 우수 기업 등 고객들이 관심을 가지기 좋은 기업 군집을 생성**
    - PER, PBR 등의 지표를 군집화하여 기업을 평가한 이유는 해석하는 기준이 매년 달라질 수 있으며 상대적인 지표이기 때문이었는데 이러한 경우 매번 해석 해야 하는 단점
        - 이에 자동으로 해석할 수 있도록 하는 기준을 만들어 제시했어야 하는데 그러지 못함
    - ESG와 같은 여러 지표를 추가해서 진행했으면 더 다양한 기업 평가 가능했을 것
- **`투자성향에 따른 종목추천`**
    - 고객이 속한 군집에서 주로 매입하는 종목 및 기업 특징 제공. 기업 특징은 기업 군집화와 연결지어 우수기업, 리스크 기업 등을 지칭
    - 고객이 속한 군집의 고수들이 주로 매입하는 종목 및 기업 특징 제공
    - 투자성향이 위험하거나 투자성향이 없는 고객들에게 위험성 있는 기업 군집은 피하고 투자에 도움이 될만한 기업 추천
- **`뉴스 데이터를 활용한 산업 별 시황분석`**
    - 산업 별 종합 시황 지수를 생성함으로써 관심있는 산업의 시황을 파악하고 각각 필요한 뉴스 정보를 손쉽게 찾을 수 있음
    - 투자자들은 본인이 소유한 종목에 대한 정보와 종목이 속한 산업의 이슈를 실시간으로 파악하며 투자 전략 수립에 도움을 줄 수 있음
    - 각 뉴스 별 시황지수를 이용해 산업에 영향을 주는 뉴스를 선별하여 제공
    - 지수 파트를 터치하여 실시간 뉴스/공시로 이어지면서 미래에셋 뉴스 서비스에 대한 접근성을 늘릴 수 있을 것으로 예상
- **`종합`**
    - 짧은 시간 내에 기획안을 제시한 후 통과되면 분석을 제대로 진행하는 프로세스라 빠르게 아이디어를 정리했어야 함
        - 너무 많은 서비스를 기획했고, 욕심이 많았음. 1,2번 서비스를 처음부터 통합해서 진행하는 방향이 훨씬 간결했을 것. 1,2번을 더 간결하게 확인해봤어야 함. 너무 깊게 분석을 진행해서 시간 소요가 많았음
        - 1,2번 서비스에서 테스트 모델링을 위해 업종 분류가 안된 채로 했는데, 확실히 논문을 참고했던 것처럼 분류 후에 모델링을 했다면 훨씬 좋은 결과가 있었을 것(업종별로 중요시하는 지표가 다르기 때문)
        - 3번 서비스의 경우 기획하는데 시간 소요가 너무 컸고, 테스트 모델까지도 만들지 못해본 것이 아쉬움
